---
layout:     post
title:      "HMR原理及应用"
subtitle:   "hot module replacement"
date:       2018-03-11 12:00:00
author:     "Ericteen"
header-img: "img/post-bg-05.jpg"
---
# HMR 原理及应用

## 模块(Module)

在模块化编程中，开发者将程序分解成离散功能块，并将其称为模块。精心编写的模块提供了可靠的抽象能力和封装界限，应用程序中的模块都有明确的目的。

Node.js 从成型之初就支持模块化。而在 web 模块化到来之前，存在着种类繁多的 JavaScript 模块化工具。webpack 将模块的概念应用于项目中的任何文件。

webpack 用过 *loader* 可以支持各种语言和预处理器编写模块。loader 描述了如何处理非 JS 模块，并且在 bundle 中引入这些依赖。

## 模块解析规则

使用 [`enhanced-resolve`](https://github.com/webpack/enhanced-resolve) , webpack 可以解析三种路径。

### 绝对路径

```javascript
import '/home/me/file'

import 'c:\\Users\\me\\file'
```

我们已经有了文件的绝对路径，所以不需要额外的解析 (不建议使用)。

### 相对路径

```javascript
import '../src/file1'

import './file2'
```

在这种情况下，`import` 或 `require` 发生在源文件路径上下文路径 (context directory)。context directory 加上相对路径以供模块的使用。

解析相对路径

1. 查找相对当前模块的路径下是否有对应文件或文件夹
2. 是文件则直接加载
3. 是文件夹则继续查找文件夹下的 package.json 文件
4. 有 package.json 文件则按照文件中 `main` 字段的文件名来查找文件
5. 无 package.json 文件或无 `main` 字段则查找 `index.js` 文件

### 模块路径

```javascript
import 'react'
import 'module/lib/file'
```

查找当前文件目录下，父级目录及以上目录下的 `node_modules` 文件夹，看是否有对应名称的模块。

在 webpack 配置中，和模块路径解析相关的配置都在 `resolve` 字段下。

```javascript
module.exports = {
  resolve: {
    // ...
  }
}
```

## HMR

HMR(Hot Module Replacement) 即为模块热更替。在这个概念之前，我们使用过 Hot Reloading, 当代码发生更新时通知浏览器刷新页面，以避免频繁的手动刷新影响开发效率。HMR 可理解为加强版的 hot reloading，但不用刷新整个页面，只是局部替换掉部分模块代码而使其生效，可以看到变化后的效果。所以，HMR 的使用既避免了频繁手动刷新页面，也减少了刷新页面时的等待。

HMR 插件在 webpack-dev-server 中是内置的。只需要设置 webpack-dev-server 的相应参数即可。

webpack.config.js

```javascript
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const CleanWebpackPlugin = require('clean-webpack-plugin');
const webpack = require('webpack');

module.exports = {
  entry: {
    app: './src/index.js',
    print: './src/print.js'
    app: './src/index.js'
  },
  devtool: 'inline-source-map',
  devServer: {
    contentBase: './dist',
    hot: true
  },
  plugins: [
    new CleanWebpackPlugin(['dist']),
    new HtmlWebpackPlugin({
      title: 'Hot Module Replacement'
    }),
    new webpack.NamedModulesPlugin(),
    new webpack.HotModuleReplacementPlugin()
  ],
  output: {
    filename: '[name].bundle.js',
    path: path.resolve(__dirname, 'dist')
  }
};
```

注意，我们还添加了 NamedModulesPlugin，以便更容易查看要修补(patch)的依赖。在起步阶段，我们将通过在命令行中运行 npm start 来启动并运行 dev server。

修改 index.js 文件，以便当 print.js 内部发生变更时可以告诉 webpack 接受更新的模块。

index.js

```javascript
import _ from 'lodash';
import printMe from './print.js';

function component() {
  var element = document.createElement('div');
  var btn = document.createElement('button');

  element.innerHTML = _.join(['Hello', 'webpack'], ' ');

  btn.innerHTML = 'Click me and check the console!';
  btn.onclick = printMe;

  element.appendChild(btn);

  return element;
}

document.body.appendChild(component());

if (module.hot) {
  module.hot.accept('./print.js', function() {
    console.log('Accepting the updated printMe module!');
    printMe();
  })
}
```