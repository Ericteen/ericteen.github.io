---
layout:     post
title:      "HMR原理及应用"
subtitle:   "hot module replacement"
date:       2018-03-11 12:00:00
author:     "Ericteen"
header-img: "img/post-bg-05.jpg"
---
# HMR 原理及应用

## 模块(Module)

在模块化编程中，开发者将程序分解成离散功能块，并将其称为模块。精心编写的模块提供了可靠的抽象能力和封装界限，应用程序中的模块都有明确的目的。

Node.js 从成型之初就支持模块化。而在 web 模块化到来之前，存在着种类繁多的 JavaScript 模块化工具。webpack 将模块的概念应用于项目中的任何文件。

webpack 用过 *loader* 可以支持各种语言和预处理器编写模块。loader 描述了如何处理非 JS 模块，并且在 bundle 中引入这些依赖。

## HMR

HMR(Hot Module Replacement) 即为模块热更替。在这个概念之前，我们使用过 Hot Reloading, 当代码发生更新时通知浏览器刷新页面，以避免频繁的手动刷新影响开发效率。HMR 可理解为加强版的 hot reloading，但不用刷新整个页面，只是局部替换掉部分模块代码而使其生效，可以看到变化后的效果。所以，HMR 的使用既避免了频繁手动刷新页面，也减少了刷新页面时的等待。

HMR 插件在 webpack-dev-server 中是内置的。只需要设置 webpack-dev-server 的相应参数即可。

webpack.config.js

```javascript
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const CleanWebpackPlugin = require('clean-webpack-plugin');
const webpack = require('webpack');

module.exports = {
  entry: {
    app: './src/index.js',
    print: './src/print.js'
    app: './src/index.js'
  },
  devtool: 'inline-source-map',
  devServer: {
    contentBase: './dist',
    hot: true
  },
  plugins: [
    new CleanWebpackPlugin(['dist']),
    new HtmlWebpackPlugin({
      title: 'Hot Module Replacement'
    }),
    new webpack.NamedModulesPlugin(),
    new webpack.HotModuleReplacementPlugin()
  ],
  output: {
    filename: '[name].bundle.js',
    path: path.resolve(__dirname, 'dist')
  }
};
```

注意，我们还添加了 NamedModulesPlugin，以便更容易查看要修补(patch)的依赖。在起步阶段，我们将通过在命令行中运行 npm start 来启动并运行 dev server。

修改 index.js 文件，以便当 print.js 内部发生变更时可以告诉 webpack 接受更新的模块。

index.js

```javascript
import _ from 'lodash';
import printMe from './print.js';

function component() {
  var element = document.createElement('div');
  var btn = document.createElement('button');

  element.innerHTML = _.join(['Hello', 'webpack'], ' ');

  btn.innerHTML = 'Click me and check the console!';
  btn.onclick = printMe;

  element.appendChild(btn);

  return element;
}

document.body.appendChild(component());

if (module.hot) {
  module.hot.accept('./print.js', function() {
    console.log('Accepting the updated printMe module!');
    printMe();
  })
}
```